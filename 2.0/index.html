<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Proof OF</title>
  <link rel="icon" href="proofofico.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&display=swap" rel="stylesheet">
  <style>
    /* ───────── SCREEN STYLES ───────────────────────────────────────── */
    :root {
      --bg: #fff; --fg: #111;
      --panel-bg: #f4f4f4; --border: #ccc;
      --accent: #00BBBB;
      --btn-bg: var(--accent); --btn-fg: #fff;
      --input-bg: #fff; --input-fg: var(--fg);
    }
    .dark-mode {
      --bg: #1e1e1e; --fg: #eee;
      --panel-bg: #2a2a2a; --border: #555;
      --accent: #3399ff; --btn-fg: #000;
      --input-bg: #2a2a2a; --input-fg: #fff;
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; height: 100vh;
      display: flex; flex-direction: column;
      font-family: 'Roboto Condensed', sans-serif;
      background: var(--bg); color: var(--fg);
      transition: background .3s, color .3s;
    }
    .top-panel { flex: 1; display: flex; flex-direction: column; overflow: auto; }
    .bottom-panel {
      flex: 1; display: flex; flex-direction: column; overflow: hidden;
      border-top: 1px solid var(--border);
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: .5em 1em; background: var(--panel-bg);
      border-bottom: 1px solid var(--border);
    }
    #logo { max-height: 2rem; width: auto; }
    header > div { display: flex; gap: .5em; }
    #clearJobsBtn, #themeToggle { font-size: .8rem; white-space: nowrap; }
    header button { flex: 1; }
    button {
      font: inherit; background: var(--btn-bg); color: var(--btn-fg);
      border: none; border-radius: 4px; padding: .5em 1em;
      cursor: pointer; transition: opacity .2s;
    }
    button:disabled { opacity: .5; cursor: default; }
    .btn-assigned { background: #FFA500; }
    input, select, textarea {
      font: inherit; width: 100%; padding: .4em;
      border: 1px solid var(--border); border-radius: 4px;
      background: var(--input-bg); color: var(--input-fg);
    }
    main { padding: .5em; }
    #startOverlay, .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex; align-items: center; justify-content: center;
      z-index: 10;
    }
    #startBox, .modal-box {
      background: var(--panel-bg);
      border: 1px solid var(--border); border-radius: 6px;
      padding: 1em; width: 320px; max-width: 90%;
    }
    .modal-box h2 { margin-top: 0; color: var(--accent); }
    .modal-box label { display: block; margin: .5em 0; }
    .modal-buttons {
      margin-top: 1em; display: flex; gap: .5em; justify-content: flex-end;
    }
    /* Location Finder Modal Styles */
    .location-finder-modal .modal-box {
      width: 600px; max-width: 95%;
    }
    .location-search-input {
      width: 100%; padding: .5em; margin-bottom: 1em;
      border: 1px solid var(--border); border-radius: 4px;
      background: var(--input-bg); color: var(--input-fg);
      font-size: 1em;
    }
    .location-results {
      max-height: 400px; overflow-y: auto;
      border: 1px solid var(--border); border-radius: 4px;
      background: var(--input-bg);
    }
    .location-item {
      padding: .75em; border-bottom: 1px solid var(--border);
      cursor: pointer; transition: background-color .2s;
    }
    .location-item:last-child { border-bottom: none; }
    .location-item:hover {
      background: var(--accent); color: var(--btn-fg);
    }
    .location-item-main {
      font-weight: bold; margin-bottom: .25em;
    }
    .location-item-details {
      font-size: .9em; opacity: .8;
    }
    .find-location-btn {
      background: var(--accent); color: var(--btn-fg);
      border: none; border-radius: 4px; padding: .3em .6em;
      cursor: pointer; font-size: .85em; margin-left: .5em;
    }
    .location-input-group {
      display: flex; align-items: center;
    }
    .location-input-group input {
      flex: 1; margin-right: .5em;
    }
    #jobForm {
      display: grid; grid-template-columns: 1fr 1fr; gap: 1em;
      background: var(--panel-bg); border: 1px solid var(--border);
      border-radius: 5px; padding: .5em; margin-bottom: .5em;
    }
    #reqDisplay {
      grid-column: 1 / -1; font-weight: bold; color: var(--accent);
      padding: .5em; background: var(--bg);
      border: 1px solid var(--border); border-radius: 4px;
      display: flex; justify-content: space-between;
    }
    fieldset {
      border: 1px solid var(--border); border-radius: 4px;
      background: var(--bg); padding: .75em;
    }
    legend {
      padding: 0 .5em; font-weight: bold; color: var(--accent);
    }
    .table-wrapper { flex: 1; overflow-y: auto; }
    table {
      width: 100%; border-collapse: collapse; font-size: .95em;
    }
    thead { background: var(--panel-bg); }
    thead th {
      position: sticky; top: 0; background: var(--panel-bg);
      padding: .4em .6em; text-align: left; z-index: 2;
    }
    thead th input {
      width: 100%; padding: .3em; margin-top: .3em;
      border: 1px solid var(--border); border-radius: 4px;
    }
    tbody td {
      padding: .4em .6em; border: 1px solid var(--border);
    }
    /* hidden print area */
    #printArea { display: none; }
    .no-print { }
    .print-only { display: none; }

    /* ───────── PRINT STYLES ────────────────────────────────────────── */
    @media print {
      @page { size: A4 portrait; margin: .5cm; }
      html, body {
        display: block; margin: 0; padding: 0;
        font-size: .85em; color: #000; background: #fff;
      }
      .top-panel, .bottom-panel, .modal-overlay { display: none !important; }
      header, #jobForm, .modal-box, #clearJobsBtn, #themeToggle,
      .modal-buttons, thead th input { display: none !important; }
      #printArea { display: block; padding: 0; margin: 0; }
      .job-print {
        page-break-after: always; margin-bottom: 1cm;
        border: 1px solid #888; padding: .5cm; font-size: 12px;
      }
      .prt-header {
        display: flex; justify-content: space-between; align-items: center;
      }
      .prt-logo { max-height: 1.5cm; width: auto; }
      .prt-reqid { font-size: 1.1em; }
      .prt-row {
        display: flex; justify-content: space-between; margin-top: .3cm;
      }
      .prt-col-left, .prt-col-right { width: 48%; }
      .prt-desc { margin: .3cm 0; }
      .prt-footer {
        display: flex; justify-content: space-between;
      }
      .prt-footer-left, .prt-footer-right { width: 48%; }
    }
  </style>
</head>
<body>
  <div class="top-panel">
    <!-- Startup modal -->
    <div id="startOverlay">
      <div id="startBox">
        <h2>Configure Logger</h2>
        <label>Initials:
          <input type="text" id="userInit" maxlength="5" placeholder="AZ">
        </label>
        <label>Start No:
          <input type="number" id="startNum" min="0" value="1">
        </label>
        <button id="beginBtn">Start</button>
      </div>
    </div>

    <!-- Header -->
    <header>
      <img src="proofoflogo.png" alt="Proof OF Logo" id="logo">
      <div>
        <button id="clearJobsBtn" disabled>Clear Tasks</button>
        <button id="themeToggle">☾ Dark Mode</button>
      </div>
    </header>

    <!-- Job form -->
    <main>
      <form id="jobForm">
        <div id="reqDisplay">
          Next Req ID: <span id="nextReq">—</span>
        </div>
        <fieldset>
          <legend>Locations</legend>
          <label>From Dept:
            <input list="deptList" id="fromDept" required placeholder="Department">
          </label>
          <label>From Location:
            <div class="location-input-group">
              <input list="fromLocList" id="fromLoc" required placeholder="Room…">
              <button type="button" class="find-location-btn" data-target="from">Find</button>
            </div>
          </label>
          <label>To Dept:
            <input list="deptList" id="toDept" placeholder="Department">
          </label>
          <label>To Location:
            <div class="location-input-group">
              <input list="toLocList" id="toLoc" placeholder="Room…">
              <button type="button" class="find-location-btn" data-target="to">Find</button>
            </div>
          </label>
        </fieldset>
        <fieldset>
          <legend>Details</legend>
          <label>Category:
            <input list="catList" id="category" required placeholder="Filter or type">
          </label>
          <label>Priority:
            <select id="priority">
              <option>Non-Urgent</option>
              <option>Urgent</option>
            </select>
          </label>
          <label>Description:
            <textarea id="description" rows="4" placeholder="Task details…"></textarea>
          </label>
        </fieldset>
        <div style="grid-column:1/-1;text-align:right;">
          <button id="addJobBtn" type="submit" disabled>Log Task</button>
        </div>
      </form>
    </main>
  </div>

  <!-- Screen table -->
  <div class="bottom-panel">
    <div class="table-wrapper">
      <table id="jobsTable">
        <colgroup>
          <col style="width:5%">
          <col style="width:15%">
          <col style="width:15%">
          <col style="width:10%">
          <col style="width:5%">
          <col style="width:37%">
          <col style="width:8%">
          <col style="width:5%">
        </colgroup>
        <thead>
          <tr>
            <th>Req ID<br><input type="text" data-col="0" placeholder="Filter"></th>
            <th>From Dept → Loc<br><input type="text" data-col="1" placeholder="Filter"></th>
            <th>To Dept → Loc<br><input type="text" data-col="2" placeholder="Filter"></th>
            <th>Category<br><input type="text" data-col="3" placeholder="Filter"></th>
            <th>Priority<br><input type="text" data-col="4" placeholder="Filter"></th>
            <th>Description<br><input type="text" data-col="5" placeholder="Filter"></th>
            <th class="print-only">Assigned To</th>
            <th class="no-print">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Print-area container -->
  <div id="printArea"></div>

  <!-- Edit modal -->
  <div id="editOverlay" class="modal-overlay" style="display:none;">
    <div class="modal-box">
      <h2>Edit Task</h2>
      <form id="editForm">
        <fieldset>
          <legend>Locations</legend>
          <label>From Dept:
            <input list="deptList" id="fromDeptEdit" required>
          </label>
          <label>From Location:
            <input list="fromLocList" id="fromLocEdit" required>
          </label>
          <label>To Dept:
            <input list="deptList" id="toDeptEdit">
          </label>
          <label>To Location:
            <input list="toLocList" id="toLocEdit">
          </label>
        </fieldset>
        <fieldset>
          <legend>Details</legend>
          <label>Category:
            <input list="catList" id="categoryEdit" required>
          </label>
          <label>Priority:
            <select id="priorityEdit">
              <option>Non-Urgent</option>
              <option>Urgent</option>
            </select>
          </label>
          <label>Description:
            <textarea id="descriptionEdit" rows="4"></textarea>
          </label>
        </fieldset>
        <div class="modal-buttons">
          <button type="submit">Save Edits</button>
          <button type="button" id="cancelEditBtn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Assign modal -->
  <div id="assignOverlay" class="modal-overlay" style="display:none;">
    <div class="modal-box">
      <h2>Assign Task</h2>
      <form id="assignForm">
        <label>Assign method:
          <select id="assignMethod" required>
            <option value="">-- select --</option>
            <option>Phone</option>
            <option>Email</option>
            <option>Direct</option>
          </select>
        </label>
        <div id="assignFields"></div>
        <div class="modal-buttons">
          <button type="submit" id="assignSubmitBtn">Assign</button>
          <button type="button" id="cancelAssignBtn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Location Finder Modal -->
  <div id="locationFinderOverlay" class="modal-overlay location-finder-modal" style="display:none;">
    <div class="modal-box">
      <h2>Find Location</h2>
      <input type="text" id="locationSearchInput" class="location-search-input" 
             placeholder="Search by site, building, department, description, room number, or floor...">
      <div id="locationResults" class="location-results">
        <div class="location-item" style="text-align: center; padding: 2em; opacity: 0.6;">
          Type to search locations...
        </div>
      </div>
      <div class="modal-buttons">
        <button type="button" id="cancelLocationFinderBtn">Close</button>
      </div>
    </div>
  </div>

  <!-- Datalists -->
  <datalist id="deptList"></datalist>
  <datalist id="fromLocList"></datalist>
  <datalist id="toLocList"></datalist>
  <datalist id="catList"></datalist>
  <script src="locations/locations-data.js"></script>
  <script src="js/locations.js"></script>
  <script src="js/categories.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ─── Helpers ─────────────────────────────────────────────────────────
    function escapeRE(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
    function buildDatalist(id, items){
      const dl=document.getElementById(id); dl.innerHTML='';
      items.forEach(v=>{ const o=document.createElement('option'); o.value=v; dl.appendChild(o); });
    }
    function makeFilter(all){
      return val=>{
        val=val.trim();
        if(!val) return all;
        if(val.includes('*')){
          const pat='^'+val.split('*').map(escapeRE).join('.*')+'$';
          const re=new RegExp(pat,'i');
          return all.filter(x=>re.test(x));
        }
        return all.filter(x=>x.toLowerCase().includes(val.toLowerCase()));
      };
    }

    // ─── State & Elements ───────────────────────────────────────────────
    let savedJobs = JSON.parse(localStorage.getItem('jobs')||'[]');
    let userInit='', jobCounter=0;
    const clearJobsBtn=document.getElementById('clearJobsBtn'),
          jobForm=document.getElementById('jobForm'),
          addJobBtn=document.getElementById('addJobBtn'),
          nextReqEl=document.getElementById('nextReq'),
          printArea=document.getElementById('printArea');

    // Enable “Log Task” when form valid
    jobForm.addEventListener('input', () => {
      addJobBtn.disabled = !jobForm.checkValidity();
    });

    // ─── Render Table ───────────────────────────────────────────────────
    function renderJobs(){
      const tb=document.querySelector('#jobsTable tbody');
      tb.innerHTML='';
      savedJobs.forEach((job,i)=>{
        const tr=document.createElement('tr');
        ['req','from','to','cat','pri','desc'].forEach(k=>{
          const td=document.createElement('td');
          td.textContent=job[k];
          tr.appendChild(td);
        });
        // Assigned column (print-only)
        const atd=document.createElement('td');
        atd.classList.add('print-only');
        let assignTxt='Unassigned';
        if(job.assignMethod){
          assignTxt=job.assignName;
          if(job.assignMethod==='Phone') assignTxt+=` (${job.assignExtension})`;
          if(job.assignMethod==='Email') assignTxt+=` <${job.assignEmail}>`;
        }
        atd.textContent=assignTxt;
        tr.appendChild(atd);

        // Actions (no-print)
        const act=document.createElement('td');
        act.classList.add('no-print');
        // Print single
        const pb=document.createElement('button');
        pb.textContent='Print';
        pb.onclick=()=>printSingleJob(i);
        act.appendChild(pb);
        // Edit
        const eb=document.createElement('button');
        eb.textContent='Edit';
        eb.onclick=()=>openEditModal(i);
        act.appendChild(eb);
        // Assign
        const ab=document.createElement('button');
        ab.textContent=job.assignMethod?'Assigned':'Assign';
        if(job.assignMethod) ab.classList.add('btn-assigned');
        ab.onclick=()=>openAssignModal(i);
        act.appendChild(ab);

        tr.appendChild(act);
        tb.appendChild(tr);
      });
      clearJobsBtn.disabled = !savedJobs.length;
    }

    // ─── Print One ─────────────────────────────────────────────────────
    function printSingleJob(i){
      const job=savedJobs[i];
      const html=`
        <div class="job-print">
          <div class="prt-header">
            <img src="proofoflogo.png" class="prt-logo" alt="Logo">
            <div class="prt-reqid">Req ID: ${job.req}</div>
          </div>
          <div class="prt-row">
            <div class="prt-col-left"><strong>From:</strong> ${job.from}</div>
            <div class="prt-col-right"><strong>Assigned To:</strong> ${
              job.assignMethod
                ? `${job.assignName}`+
                  (job.assignMethod==='Phone'?` (${job.assignExtension})`:``)+
                  (job.assignMethod==='Email'?` <${job.assignEmail}>`:``)
                : 'UNASSIGNED'
            }</div>
          </div>
          <div class="prt-row">
            <div class="prt-col-left"><strong>To:</strong> ${job.to}</div>
            <div class="prt-col-right">&nbsp;</div>
          </div>
          <div class="prt-desc"><strong>Description:</strong><br>${job.desc}</div>
          <div class="prt-footer">
            <div class="prt-footer-left"><strong>Priority:</strong> ${job.pri}</div>
            <div class="prt-footer-right"><strong>Category:</strong> ${job.cat}</div>
          </div>
        </div>`;
      printArea.innerHTML=html;
      window.print();
      printArea.innerHTML='';
    }

    // ─── Theme Toggle ───────────────────────────────────────────────────
    const themeBtn=document.getElementById('themeToggle');
    function setTheme(d){
      document.body.classList.toggle('dark-mode',d);
      themeBtn.textContent=d?'Light Mode':'☾ Dark Mode';
      localStorage.setItem('darkMode',d);
    }
    themeBtn.onclick=()=>setTheme(!document.body.classList.contains('dark-mode'));
    setTheme(localStorage.getItem('darkMode')==='true');

    // ─── Start Handler ─────────────────────────────────────────────────
    document.getElementById('beginBtn').onclick=()=>{
      const i=document.getElementById('userInit').value.trim().toUpperCase();
      const n=parseInt(document.getElementById('startNum').value,10);
      if(!i||isNaN(n)) return alert('Enter initials & start number');
      userInit=i; jobCounter=n; updateNextReq();
      document.getElementById('startOverlay').style.display='none';
      initLocationLists(); initCategoryList(); renderJobs();
    };

    // ─── Location Lists Init ───────────────────────────────────────────
    let deptLocMap={}, deptOptions=[];
    function initLocationLists(){
      deptLocMap={};
      (window.LOCATIONS||[]).forEach(r=>{
        const d=(r.Department||'').trim(),
              rm=(r['Room Number']||'').trim(),
              ds=(r.Description||'').trim();
        if(!d||!rm) return;
        const lbl=ds?`${rm} – ${ds}`:rm;
        (deptLocMap[d]||=[]).push(lbl);
      });
      Object.values(deptLocMap).forEach(a=>a.sort());
      deptOptions=Object.keys(deptLocMap).sort();
      buildDatalist('deptList',deptOptions);
      buildDatalist('fromLocList',[]);
      buildDatalist('toLocList',[]);
      ['fromDept','toDept','fromDeptEdit','toDeptEdit'].forEach(id=>{
        document.getElementById(id).oninput=()=>{
          const f=makeFilter(deptOptions);
          buildDatalist('deptList',f(document.getElementById(id).value));
          const rooms=deptLocMap[document.getElementById(id).value.trim()]||[];
          const listId=id.includes('Edit')
            ? (id==='fromDeptEdit'?'fromLocList':'toLocList')
            : (id==='fromDept'?'fromLocList':'toLocList');
          buildDatalist(listId,rooms);
        };
      });
    }

    // ─── Category List Init ────────────────────────────────────────────
    function initCategoryList(){
      if(!Array.isArray(window.CATEGORIES)) return;
      buildDatalist('catList',window.CATEGORIES);
      ['category','categoryEdit'].forEach(id=>{
        document.getElementById(id).oninput=()=>{
          const f=makeFilter(window.CATEGORIES);
          buildDatalist('catList',f(document.getElementById(id).value));
        };
      });
    }

    // ─── Req-ID & Submit ───────────────────────────────────────────────
    function zeroPad(n,len=7){return n.toString().padStart(len,'0');}
    function updateNextReq(){ nextReqEl.textContent=`${userInit}${zeroPad(jobCounter)}`; }
    jobForm.onsubmit=e=>{
      e.preventDefault();
      const fD=e.target.fromDept.value,fL=e.target.fromLoc.value,
            tD=e.target.toDept.value||'',tL=e.target.toLoc.value||'',
            cat=e.target.category.value,pri=e.target.priority.value,
            desc=e.target.description.value.replace(/\n/g,' ');
      const req=`${userInit}${zeroPad(jobCounter)}`;
      savedJobs.push({req,from:`${fD} → ${fL}`,to:(tD&&tL)?`${tD} → ${tL}`:'',cat,pri,desc});
      localStorage.setItem('jobs',JSON.stringify(savedJobs));
      renderJobs(); jobCounter++; updateNextReq();
      e.target.reset(); clearJobsBtn.disabled=false;
    };

    // ─── Clear All ─────────────────────────────────────────────────────
    clearJobsBtn.onclick=()=>{
      if(!confirm('Clear all saved tasks?')) return;
      savedJobs=[]; localStorage.removeItem('jobs'); renderJobs();
    };

    // ─── Table Filtering ───────────────────────────────────────────────
    document.querySelectorAll('#jobsTable thead input[data-col]')
      .forEach(inp=>inp.oninput=()=>{
        const terms=Array.from(document.querySelectorAll('#jobsTable thead input[data-col]'))
          .map(i=>i.value.trim().toLowerCase());
        document.querySelectorAll('#jobsTable tbody tr').forEach(row=>{
          const cells=Array.from(row.cells);
          const ok=terms.every((t,i)=>!t||cells[i].textContent.toLowerCase().includes(t));
          row.style.display=ok?'':'none';
        });
      });

    // ─── Edit Modal Logic ─────────────────────────────────────────────
    let currentEditIndex=null;
    const editOverlay=document.getElementById('editOverlay'),
          editForm=document.getElementById('editForm'),
          cancelEdit=document.getElementById('cancelEditBtn');
    cancelEdit.onclick=()=>editOverlay.style.display='none';
    function openEditModal(i){
      currentEditIndex=i;
      const job=savedJobs[i];
      const [fD,fL]=job.from.split(' → ');
      const [tD,tL]=job.to.split(' → ');
      document.getElementById('fromDeptEdit').value=fD||'';
      document.getElementById('fromLocEdit').value=fL||'';
      document.getElementById('toDeptEdit').value=tD||'';
      document.getElementById('toLocEdit').value=tL||'';
      document.getElementById('categoryEdit').value=job.cat;
      document.getElementById('priorityEdit').value=job.pri;
      document.getElementById('descriptionEdit').value=job.desc;
      editOverlay.style.display='flex';
    }
    editForm.onsubmit=e=>{
      e.preventDefault();
      const fD=document.getElementById('fromDeptEdit').value,
            fL=document.getElementById('fromLocEdit').value,
            tD=document.getElementById('toDeptEdit').value||'',
            tL=document.getElementById('toLocEdit').value||'',
            cat=document.getElementById('categoryEdit').value,
            pri=document.getElementById('priorityEdit').value,
            desc=document.getElementById('descriptionEdit').value.replace(/\n/g,' ');
      const job=savedJobs[currentEditIndex];
      job.from=`${fD} → ${fL}`; job.to=(tD&&tL)?`${tD} → ${tL}`:''; job.cat=cat; job.pri=pri; job.desc=desc;
      localStorage.setItem('jobs',JSON.stringify(savedJobs));
      renderJobs(); editOverlay.style.display='none';
    };

    // ─── Assign Modal Logic (fixed!) ──────────────────────────────────
    let currentAssignIndex = null;
    const assignOverlay    = document.getElementById('assignOverlay'),
          assignForm       = document.getElementById('assignForm'),
          assignMethod     = document.getElementById('assignMethod'),
          assignFields     = document.getElementById('assignFields'),
          cancelAssign     = document.getElementById('cancelAssignBtn');

    // close
    cancelAssign.onclick = () => assignOverlay.style.display = 'none';

    // open, store index, populate method & fields
    function openAssignModal(i){
      currentAssignIndex = i;
      const job = savedJobs[i] || {};
      assignMethod.value = job.assignMethod || '';
      updateAssignFields();
      assignOverlay.style.display = 'flex';
    }

    // rebuild fields based on method and job data
    function updateAssignFields(){
      const job = savedJobs[currentAssignIndex] || {};
      const m = assignMethod.value;
      let html = '';
      if(m==='Phone'){
        html = `
          <label>Name:<input id="assignName" required></label>
          <label>Extension:<input id="assignExtension" required></label>`;
      } else if(m==='Email'){
        html = `
          <label>Name:<input id="assignName" required></label>
          <label>Email:<input type="email" id="assignEmail" required></label>`;
      } else if(m==='Direct'){
        html = `<label>Name:<input id="assignName" required></label>`;
      }
      assignFields.innerHTML = html;
      // fill in existing values
      if(job.assignName)      document.getElementById('assignName').value = job.assignName;
      if(m==='Phone' && job.assignExtension)
        document.getElementById('assignExtension').value = job.assignExtension;
      if(m==='Email' && job.assignEmail)
        document.getElementById('assignEmail').value = job.assignEmail;
    }
    assignMethod.onchange = updateAssignFields;

    // save assignment
    assignForm.onsubmit = e => {
      e.preventDefault();
      const m   = assignMethod.value;
      const nm  = document.getElementById('assignName').value.trim();
      const ext = m==='Phone'
        ? document.getElementById('assignExtension').value.trim() : '';
      const eml = m==='Email'
        ? document.getElementById('assignEmail').value.trim() : '';
      const job = savedJobs[currentAssignIndex];
      job.assignMethod    = m;
      job.assignName      = nm;
      if(m==='Phone') job.assignExtension = ext;
      if(m==='Email') job.assignEmail     = eml;
      localStorage.setItem('jobs', JSON.stringify(savedJobs));
      renderJobs();
      assignOverlay.style.display = 'none';
    };

    // ─── Location Finder Modal Logic ─────────────────────────────────────
    let currentLocationTarget = null;
    const locationFinderOverlay = document.getElementById('locationFinderOverlay'),
          locationSearchInput = document.getElementById('locationSearchInput'),
          locationResults = document.getElementById('locationResults'),
          cancelLocationFinder = document.getElementById('cancelLocationFinderBtn');

    // Close modal
    cancelLocationFinder.onclick = () => locationFinderOverlay.style.display = 'none';

    // Open location finder modal
    function openLocationFinder(target) {
      currentLocationTarget = target;
      locationSearchInput.value = '';
      showDefaultLocationMessage();
      locationFinderOverlay.style.display = 'flex';
      setTimeout(() => locationSearchInput.focus(), 100);
    }

    // Show default message
    function showDefaultLocationMessage() {
      locationResults.innerHTML = `
        <div class="location-item" style="text-align: center; padding: 2em; opacity: 0.6;">
          Type to search locations...
        </div>
      `;
    }

    // Search locations
    function searchLocations(searchTerm) {
      if (!searchTerm.trim()) {
        showDefaultLocationMessage();
        return;
      }

      const locations = window.LOCATION_DATA || [];
      const term = searchTerm.toLowerCase();
      
      const matches = locations.filter(location => {
        return (
          (location.Site && location.Site.toLowerCase().includes(term)) ||
          (location.Building && location.Building.toLowerCase().includes(term)) ||
          (location.Department && location.Department.toLowerCase().includes(term)) ||
          (location.Description && location.Description.toLowerCase().includes(term)) ||
          (location['Room Number'] && location['Room Number'].toLowerCase().includes(term)) ||
          (location.Floor && location.Floor.toLowerCase().includes(term))
        );
      });

      displayLocationResults(matches);
    }

    // Display search results
    function displayLocationResults(matches) {
      if (matches.length === 0) {
        locationResults.innerHTML = `
          <div class="location-item" style="text-align: center; padding: 2em; opacity: 0.6;">
            No locations found
          </div>
        `;
        return;
      }

      const html = matches.slice(0, 100).map(location => `
        <div class="location-item" data-location='${JSON.stringify(location).replace(/'/g, "&#39;")}'>
          <div class="location-item-main">
            ${location['Room Number']} - ${location.Description || 'No description'}
          </div>
          <div class="location-item-details">
            ${location.Site} | ${location.Building} | ${location.Department} | Floor: ${location.Floor}
          </div>
        </div>
      `).join('');

      locationResults.innerHTML = html;

      // Add click handlers
      locationResults.querySelectorAll('.location-item').forEach(item => {
        item.onclick = () => selectLocation(JSON.parse(item.dataset.location));
      });
    }

    // Select a location
    function selectLocation(location) {
      if (!currentLocationTarget) return;

      const deptInput = document.getElementById(currentLocationTarget === 'from' ? 'fromDept' : 'toDept');
      const locInput = document.getElementById(currentLocationTarget === 'from' ? 'fromLoc' : 'toLoc');

      // Set department
      if (location.Department) {
        deptInput.value = location.Department;
        // Trigger input event to update the datalist
        deptInput.dispatchEvent(new Event('input'));
      }

      // Set location
      const locationLabel = location.Description 
        ? `${location['Room Number']} – ${location.Description}`
        : location['Room Number'];
      locInput.value = locationLabel;

      // Close modal
      locationFinderOverlay.style.display = 'none';
    }

    // Search input handler
    locationSearchInput.oninput = (e) => {
      searchLocations(e.target.value);
    };

    // Find location button handlers
    document.querySelectorAll('.find-location-btn').forEach(btn => {
      btn.onclick = () => openLocationFinder(btn.dataset.target);
    });

    // initial
    renderJobs();
  });
  </script>
</body>
</html>